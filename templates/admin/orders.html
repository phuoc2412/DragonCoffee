{# /templates/admin/orders.html #}
{% extends "admin/base.html" %}
{% from "macros/_ui_helpers.html" import render_pagination, status_badge %}

{% block title %}Quáº£n lÃ½ ÄÆ¡n hÃ ng - Trang quáº£n trá»‹{% endblock %}

{% block page_title %}Quáº£n lÃ½ ÄÆ¡n hÃ ng{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Báº£ng Ä‘iá»u khiá»ƒn</a></li>
    <li class="breadcrumb-item active">ÄÆ¡n hÃ ng</li>
{% endblock %}

{% block content %}
<div class="card card-outline card-primary shadow-sm mb-4"> {# ThÃªm card-outline vÃ  mÃ u primary #}
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2"> {# DÃ¹ng flex vÃ  gap #}
            <h3 class="card-title mb-0">Bá»™ lá»c ÄÆ¡n hÃ ng</h3>
            <div class="d-flex align-items-center flex-wrap gap-2"> {# NhÃ³m cÃ¡c controls #}
                {# === FORM Lá»ŒC / TÃŒM KIáº¾M Äá»˜NG === #}
                <div class="input-group input-group-sm" style="width: 280px;">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    {# Input tÃ¬m kiáº¿m - THÃŠM ID #}
                    <input type="search" id="orderSearchInput" class="form-control" placeholder="TÃ¬m ID, TÃªn, SÄT, Email..." aria-label="TÃ¬m kiáº¿m Ä‘Æ¡n hÃ ng" value="{{ q or '' }}">
                </div>
                {# Dropdown lá»c tráº¡ng thÃ¡i - THÃŠM ID #}
                <select id="orderStatusFilter" class="form-select form-select-sm" style="width: 170px;" aria-label="Lá»c theo tráº¡ng thÃ¡i">
                    <option value="" {% if not status %}selected{% endif %}>Táº¥t cáº£ tráº¡ng thÃ¡i</option>
                    {# ThÃªm giÃ¡ trá»‹ cá»¥ thá»ƒ vÃ  láº¥y tráº¡ng thÃ¡i hiá»‡n táº¡i 'status' #}
                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>â³ Chá» xá»­ lÃ½</option>
                    <option value="processing" {% if status == 'processing' %}selected{% endif %}>âš™ï¸ Äang xá»­ lÃ½</option>
                    <option value="ready_for_pickup" {% if status == 'ready_for_pickup' %}selected{% endif %}>ğŸ Sáºµn sÃ ng láº¥y</option>
                    <option value="out_for_delivery" {% if status == 'out_for_delivery' %}selected{% endif %}>ğŸšš Äang giao</option>
                    <option value="completed" {% if status == 'completed' %}selected{% endif %}>âœ… HoÃ n thÃ nh</option>
                    <option value="delivered" {% if status == 'delivered' %}selected{% endif %}>ğŸ ÄÃ£ giao</option>
                    <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>âŒ ÄÃ£ há»§y</option>
                    <option value="failed" {% if status == 'failed' %}selected{% endif %}>âš ï¸ Tháº¥t báº¡i</option>
                </select>
                {# ---- NÃšT EXPORT CSV ---- #}
                <a id="exportCsvLink" href="{{ url_for('admin.export_orders_csv', q=request.args.get('q',''), status=request.args.get('status','')) }}"
                   class="btn btn-sm btn-outline-success" title="Xuáº¥t káº¿t quáº£ hiá»‡n táº¡i ra CSV" target="_blank">
                   <i class="fas fa-file-csv"></i> Xuáº¥t
                </a>
                {# -------------------------- #}
            </div>
        </div>
    </div>
    <div class="card-body p-0"> {# Padding 0 Ä‘á»ƒ table chiáº¿m full #}
        {# Khu vá»±c hiá»ƒn thá»‹ káº¿t quáº£ table (sáº½ Ä‘Æ°á»£c cáº­p nháº­t báº±ng JS) #}
        <div id="ordersTableContainer" class="table-responsive">
            {# ThÃªm spinner khi loading AJAX #}
            <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Äang táº£i...</span>
                </div>
                <p class="mt-2">Äang táº£i Ä‘Æ¡n hÃ ng...</p>
            </div>
            {# Pháº§n table gá»‘c (sáº½ load ná»™i dung table vÃ o Ä‘Ã¢y ban Ä‘áº§u vÃ  khi AJAX) #}
            <table class="table table-striped table-hover align-middle mb-0 admin-table" id="ordersTable">
                <thead class="table-light">
                    <tr>
                        <th style="width: 8%;" class="text-center">ID</th>
                        <th style="width: 27%;">KhÃ¡ch hÃ ng</th>
                        <th style="width: 15%;">NgÃ y Ä‘áº·t</th>
                        <th style="width: 12%;" class="text-end">Tá»•ng tiá»n</th>
                        <th style="width: 12%;" class="text-center">Thanh toÃ¡n</th>
                        <th style="width: 12%;" class="text-center">Tráº¡ng thÃ¡i ÄH</th>
                        <th style="width: 14%;" class="text-center">HÃ nh Ä‘á»™ng</th> {# Giáº£m Ä‘á»™ rá»™ng Action #}
                    </tr>
                </thead>
                <tbody> {# Sáº½ Ä‘Æ°á»£c thay tháº¿ báº±ng JS #}
                    {% include 'admin/_order_table_rows.html' %} {# Include template partial cho cÃ¡c dÃ²ng ban Ä‘áº§u #}
                </tbody>
            </table>
            {# ThÃ´ng bÃ¡o khi khÃ´ng cÃ³ káº¿t quáº£ #}
            <div id="noOrdersMessage" class="text-center p-5 text-muted" style="display: {% if not pagination or not pagination.items %}block{% else %}none{% endif %};">
                 <i class="fas fa-folder-open fa-3x mb-3"></i><br>
                 {% if q or status %}
                    KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng nÃ o khá»›p vá»›i bá»™ lá»c.
                 {% else %}
                     ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o.
                 {% endif %}
             </div>
        </div>
    </div>

    {# Pháº§n phÃ¢n trang (sáº½ áº©n Ä‘i khi dÃ¹ng AJAX tÃ¬m kiáº¿m, trá»« khi lÃ m AJAX phÃ¢n trang) #}
    {% if pagination and pagination.pages > 1 %}
    <div id="paginationContainer" class="card-footer clearfix bg-light border-top">
        {{ render_pagination(pagination, 'admin.orders', q=q, status=status, align='end', size='sm') }}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %} {# Äá»•i tÃªn block script #}
{{ super() if super }} {# Giá»¯ láº¡i script tá»« base náº¿u cÃ³ #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('orderSearchInput');
    const statusFilter = document.getElementById('orderStatusFilter');
    const tableBody = document.querySelector('#ordersTable tbody');
    const tableContainer = document.getElementById('ordersTableContainer'); // Div bao ngoÃ i table
    const noOrdersMessage = document.getElementById('noOrdersMessage');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const paginationContainer = document.getElementById('paginationContainer');
    const exportCsvLink = document.getElementById('exportCsvLink'); // Link xuáº¥t CSV

    let debounceTimeout;

    function performSearch() {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            const query = searchInput.value.trim();
            const status = statusFilter.value;
            fetchOrders(query, status);

            // Cáº­p nháº­t URL export CSV
            if (exportCsvLink) {
                const exportUrl = new URL(exportCsvLink.href);
                exportUrl.searchParams.set('q', query);
                exportUrl.searchParams.set('status', status);
                exportCsvLink.href = exportUrl.toString();
            }

            // Cáº­p nháº­t URL trÃ¬nh duyá»‡t (tÃ¹y chá»n)
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('q', query);
            currentUrl.searchParams.set('status', status);
            // Bá» tham sá»‘ 'page' khi tÃ¬m kiáº¿m Ä‘á»™ng (vÃ¬ load háº¿t KQ hoáº·c vá» trang 1)
            currentUrl.searchParams.delete('page');
            history.pushState({}, '', currentUrl);

        }, 500); // Chá» 500ms sau khi ngá»«ng gÃµ/chá»n
    }

    function fetchOrders(query = '', status = '') {
        // Hiá»‡n loading, áº©n báº£ng vÃ  thÃ´ng bÃ¡o "khÃ´ng cÃ³ KQ"
        if (loadingSpinner) loadingSpinner.style.display = 'block';
        if (tableBody) tableBody.innerHTML = ''; // XÃ³a kq cÅ© ngay láº­p tá»©c
        if (noOrdersMessage) noOrdersMessage.style.display = 'none';
        if (paginationContainer) paginationContainer.style.display = 'none'; // áº¨n phÃ¢n trang khi tÃ¬m AJAX

        const apiUrl = `/admin/api/search-orders?q=${encodeURIComponent(query)}&status=${encodeURIComponent(status)}`;

        console.log("Fetching orders from:", apiUrl); // Debug

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok (${response.status})`);
                }
                return response.json();
            })
            .then(data => {
                console.log("API Response:", data); // Debug
                if (loadingSpinner) loadingSpinner.style.display = 'none'; // áº¨n loading

                if (data.success && data.html) {
                    if (tableBody) {
                        tableBody.innerHTML = data.html;
                        // Khá»Ÿi táº¡o láº¡i tooltip sau khi thÃªm ná»™i dung má»›i
                        var tooltipTriggerList = [].slice.call(tableBody.querySelectorAll('[data-bs-toggle="tooltip"]'))
                        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                            // XÃ³a instance cÅ© náº¿u cÃ³ Ä‘á»ƒ trÃ¡nh lá»—i
                            var oldTooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                            if (oldTooltip) { oldTooltip.dispose(); }
                            return new bootstrap.Tooltip(tooltipTriggerEl)
                        })
                    } else {
                         console.error("Table body not found!");
                    }
                    if (data.count === 0) { // Kiá»ƒm tra xem cÃ³ káº¿t quáº£ khÃ´ng
                        if (noOrdersMessage) noOrdersMessage.style.display = 'block';
                        if (tableBody) tableBody.innerHTML = ''; // Äáº£m báº£o body trá»‘ng
                    } else {
                        if (noOrdersMessage) noOrdersMessage.style.display = 'none';
                    }
                } else {
                     if (noOrdersMessage) {
                         noOrdersMessage.textContent = data.message || "Lá»—i khi táº£i dá»¯ liá»‡u.";
                         noOrdersMessage.style.display = 'block';
                     }
                     if (tableBody) tableBody.innerHTML = ''; // Äáº£m báº£o body trá»‘ng khi lá»—i
                     console.error("API Error:", data.message || "Unknown error");
                 }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (noOrdersMessage) {
                     noOrdersMessage.textContent = "Lá»—i káº¿t ná»‘i hoáº·c xá»­ lÃ½. Vui lÃ²ng thá»­ láº¡i.";
                     noOrdersMessage.style.display = 'block';
                }
                if (tableBody) tableBody.innerHTML = '';
            });
    }

    if (searchInput) {
        searchInput.addEventListener('input', performSearch);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', performSearch);
    }

    // --- KHá»I Táº O TOOLTIP CHO CÃC NÃšT BAN Äáº¦U ---
     var initialTooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
     var initialTooltipList = initialTooltipTriggerList.map(function (tooltipTriggerEl) {
         return new bootstrap.Tooltip(tooltipTriggerEl)
     });
});
</script>
{% endblock %}